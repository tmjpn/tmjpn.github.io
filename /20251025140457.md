# Wiki.jsセットアップ手順

## 概要

この記事では、**Raspberry Pi 4（Raspberry Pi OS）** に **Wiki.js 2.x + Node.js 22 + SQLite** 環境を構築する手順を紹介します。

> SQLite は軽量なDBのため、個人用Wikiや家庭内LANサーバーに最適です。  
> ただし Node.js のバージョンによっては `sqlite3` のビルドが必要になります。

## システム構成

|項目|内容|
|---|---|
|ハードウェア|Raspberry Pi 4（4GBモデル）|
|OS|Raspberry Pi OS（Trixie）※64bit|
|Node.js|22.18.0（nvm 管理）|
|Wiki.js|v2.5.308|
|DB|SQLite（`node-sqlite3` ビルド版）|
|インストール先|`/home/administrator/wikijs`|
|サービス管理|systemd|
|アクセス方法|LAN内のブラウザから `http://<PiのIP>:3000`|

## 1. 事前準備

まずは開発ツールと依存パッケージを導入します。

```
sudo apt update
sudo apt -y install python3 make g++ pkg-config libsqlite3-dev curl ca-certificates
```

Node.js は nvm 経由で導入済みを想定します。  
（まだの場合は以下で導入）

```
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/master/install.sh | bash
source ~/.bashrc
nvm install 22
nvm use 22
node -v && npm -v
```

## 2. Wiki.js の展開

```
mkdir -p ~/wikijs && cd ~/wikijs
wget https://github.com/Requarks/wiki/releases/latest/download/wiki-js.tar.gz
tar xzf wiki-js.tar.gz && rm wiki-js.tar.gz
```

設定ファイルを作成します。

```
cp config.sample.yml config.yml
mkdir -p data
```

SQLite 用に `config.yml` を編集：

```
db:
  type: sqlite
  storage: ./data/wiki.db

bindIP: 0.0.0.0  # 外部端末からもアクセス可能にする
port: 3000
```

## 3. SQLite3 モジュールをビルド（Node.js 22系用）

Node.js 22 では、`sqlite3` のプリビルドバイナリが存在しないため、 **ソースビルドが必要** です。

```
cd ~/wikijs
npm cache clean --force
npm config set legacy-peer-deps true
export PYTHON=/usr/bin/python3
export npm_config_python=/usr/bin/python3

npm install sqlite3 --build-from-source --legacy-peer-deps --foreground-scripts \
  || npm install sqlite3@5.1.7 --build-from-source --legacy-peer-deps --foreground-scripts
```

### 補足

この手順は「Raspberry Pi + Node 22 環境での SQLite ビルド」が要点です。  
`sqlite3` を apt で入れても Node からは利用できないため、 **npm 経由でのビルドインストールが必須** となります。

### 成功のサイン

ログ末尾に以下が出力されればOKです。

```
node-pre-gyp info ok
COPY ... node_sqlite3.node
```

## 4. 動作確認

```
cd ~/wikijs
TZ=Asia/Tokyo NODE_ENV=production node server
```

以下のようなログが出れば成功です。

```
Loading configuration from config.yml... OK
Wiki.js 2.5.308
```

→ `Ctrl+C` で停止します。

ブラウザからアクセス  
➡ `http://<RaspberryPiのIP>:3000`

初回ウィザードが表示されれば起動成功です。

## 5. systemd で自動起動設定

```
sudo tee /etc/systemd/system/wikijs.service >/dev/null <<'EOF'
[Unit]
Description=Wiki.js
After=network.target

[Service]
Type=simple
User=administrator
WorkingDirectory=/home/administrator/wikijs
Environment=NODE_ENV=production
Environment=PATH=/home/administrator/.nvm/versions/node/v22.18.0/bin:/usr/local/bin:/usr/bin:/bin
Environment=TZ=Asia/Tokyo
ExecStart=/home/administrator/.nvm/versions/node/v22.18.0/bin/node server
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable --now wikijs
sudo journalctl -u wikijs -n 50 --no-pager
```

## 6. 外部端末からアクセス

Raspberry Pi のIPアドレスを確認します。

```
hostname -I
```

例：

```
192.168.10.42
```

外部PCやスマホからブラウザでアクセス：

```
http://192.168.10.42:3000
```

これでLAN内どこからでも Wiki.js を閲覧できます。

## 7. セキュリティ・運用のポイント

### ファイアウォール設定（ufw利用時）

```
sudo ufw allow 3000/tcp
sudo ufw reload
```

または、後述の Nginx を使う場合は 80/443 のみ許可。

### バックアップ（SQLite 版）

SQLite は1ファイルなのでバックアップも簡単です。

```
sudo systemctl stop wikijs
tar czf ~/wikijs_backup_$(date +%F_%H%M%S).tar.gz -C ~/wikijs config.yml data/wiki.db data/repo
sudo systemctl start wikijs
```

## 8. （任意）Nginx リバースプロキシ設定

`:3000` を付けずにアクセスしたい場合は以下を設定。

```
sudo apt -y install nginx
sudo tee /etc/nginx/sites-available/wikijs >/dev/null <<'EOF'
server {
    listen 80;
    server_name raspi.local;

    client_max_body_size 64m;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
EOF

sudo ln -sf /etc/nginx/sites-available/wikijs /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx
```

以後は  
➡ `http://raspi.local/`  
でアクセスできます。

## 9. よくあるトラブルと対処

|症状|原因|対処|
|---|---|---|
|外部から見えない|`bindIP: 127.0.0.1` のまま|`bindIP: 0.0.0.0` に変更|
|起動時に “npm install sqlite3” エラー|Node22にプリビルドなし|手動ビルド（上記手順3）|
|Nodeを切り替えた後に起動失敗|ABIミスマッチ|`npm rebuild sqlite3 --build-from-source`|
|Nginxが起動しない|IPv6無効化済み環境|`listen [::]:80` 行を削除|

## 参考

- [Wiki.js 公式サイト](https://js.wiki/)
    
- [Requarks/wiki GitHub](https://github.com/requarks/wiki)
    
- [sqlite3 (npm)](https://www.npmjs.com/package/sqlite3)
    
- [Node.js Downloads](https://nodejs.org/en/download)
